<?php

/**
 * Skeleton subclass for representing a row from the 'negocio' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/14/18 19:18:11
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Negocio extends BaseNegocio {

    static function buscaRequerimiento(Propiedad $Propiedad) {
        NegocioQuery::create()
                ->filterByPropiedadId($Propiedad->getId())
                ->find()
                ->delete();
        sfContext::getInstance()->getUser()->setAttribute('filtro', false, "Requerimiento");
        $Requerimientos = RequerimientoQuery::create()->find();
        foreach ($Requerimientos as $fila) {
            self::match($Propiedad, $fila);
        }
    }

    static function buscaPropiedad(Requerimiento $Requerimiento) {
        NegocioQuery::create()
                ->filterByRequerimientoId($Requerimiento->getId())
                ->find()
                ->delete();
        sfContext::getInstance()->getUser()->setAttribute('filtro', false, "Propiedad");
        $Propiedades = PropiedadQuery::create()->find();
        foreach ($Propiedades as $fila) {
            self::match($fila, $Requerimiento);
        }
    }

    static function match(Propiedad $Propiedad, Requerimiento $Requerimiento) {
        $no_negocio = false;
        if (!($Propiedad->getPrecio() >= $Requerimiento->getPresupuestoMin() && $Propiedad->getPrecio() <= $Requerimiento->getPresupuestoMax())) {
            $no_negocio = true;
        }
        $direccion = false;
        foreach ($Requerimiento->getDireccionRequerimientos() as $dir) {
            if (($Propiedad->getZona() == $dir->getZona() && $Propiedad->getMunicipio() == $dir->getMunicipio()) || ($Propiedad->getCarreteraId() && $Propiedad->getCarreteraId() == $dir->getCarreteraId())) {
                $direccion = true;
                break;
            }
        }
        if (!$direccion) {
            $no_negocio = true;
        }
        switch ($Propiedad->getTipoOperacion()) {
            case "Rentar":
                if ($Requerimiento->getTipoOPeracion() != "Rentar") {
                    $no_negocio = true;
                }
                break;
            case "Vender":
                if ($Requerimiento->getTipoOPeracion() != "Comprar") {
                    $no_negocio = true;
                }
                break;
        }
        if ($Propiedad->getTipoInmueble() != $Requerimiento->getTipoInmueble()) {
            $no_negocio = true;
        }
        if ($Propiedad->getFormaPago() != $Requerimiento->getFormaPago()) {
            $no_negocio = true;
        }
        if (!($Propiedad->getEstado() == $Requerimiento->getEstado() || $Requerimiento->getEstado() == 'Indiferente')) {
            $no_negocio = true;
        }
        if ($Propiedad->getCantidadHabitacion() < $Requerimiento->getCantidadHabitacion()) {
            $no_negocio = true;
        }
        if ($Propiedad->getCantidadParqueo() < $Requerimiento->getCantidadParqueo()) {
            $no_negocio = true;
        }
        if (!$no_negocio) {
            $Negocio = new Negocio();
            $Negocio->setRequerimientoId($Requerimiento->getId());
            $Negocio->setPropiedadId($Propiedad->getId());
            $Negocio->setUsuarioReq($Requerimiento->getUsuarioId());
            $Negocio->setUsuarioProp($Propiedad->getUsuarioId());
            $Negocio->save();
        }
    }

}
